<script>
    const ctx = document.getElementById("myChart").getContext('2d');

    // removes all but amount inputs // doesnt respond to resizing
    if (window.screen.width <= 600) {
        let lis = document.querySelectorAll('ul li');
        for(let i=0; li=lis[i]; i++) {
            if (i <= 3) {
                li.parentNode.removeChild(li);
            } else if (i > 4 && i <= 8) {
                li.parentNode.removeChild(li);
            }
        }
    }


    let totalSaved = 0; // v
    let annualIncome;
    let monthlySavings = 100; // c
    let yearsWantToSave = 40;
    let totalMonthsOfSaving = yearsWantToSave * 12; // n
    const aggressive = 1.00716; // r
    const moderate = 1.0065; // r
    const conservative = 1.00549; // r
    let chartLabels = [];

    let minAge;
    let maxAge;

    let today = new Date();
    let currentYr = today.getFullYear();
    document.getElementById('year').innerText = currentYr + yearsWantToSave;

    function getPointerValues() {

    }

    $(function() {
        $("#slider-range").slider({
            range: true,
            min: 1,
            max: 100,
            minValue: undefined,
            maxValue: undefined,
            values: [ 25, 65 ],
            classes: {
                "ui-slider": "ui-corner-all slider__height",
                "ui-slider-handle": "ui-corner-all slider__btn",
                "ui-slider-range": "ui-corner-all slider__fill"
            },
            slide: function( event, ui ) {
                $("#amount").val(ui.values[0] + " - " + ui.values[1]);
                this.minValue = ui.values[0];
                this.maxValue = ui.values[1];
                yearsWantToSave = ui.values[1] - ui.values[0];
                calculateLabels(ui.values[0], ui.values[1]);
                // age set to 65 in html but updates when slider is triggered here
                document.getElementById('age').innerText = ui.values[1];
                document.getElementById('year').innerText = currentYr + yearsWantToSave;
                createChart();
            }
        });
        $("#amount").val($("#slider-range").slider("values", 0) +
            " - " + $("#slider-range").slider("values", 1));
    } );

    function calculateLabels(minAge, maxAge) {
        let output = [];
        for (let x = minAge; x <= maxAge; x++) {
            output.push(x);
        }
        chartLabels = output;
    }

    // Calculates the total saved amount
    function calculatePointer(r, total, monthly) {
        for (let i=0; i < totalMonthsOfSaving; i++) {
            totalSaved = (total * r) + monthly;
        }
        return totalSaved;
    }

    function calculateDataPointsByYear(aggressiveness) {
        let output = [];
        let accumulated = totalSaved;

        for (let i = 0; i < chartLabels.length; i++) {
            for (let x = 0; x < 12; x++) {
                accumulated = (Math.floor(accumulated * aggressiveness)) + monthlySavings;
            }
            output.push(accumulated);
        }
        return output;
    }

    let listOfCharts = [{
        destroy: function(){
            return true;
        }
    }];

    function destroyPreviousChart() {
        listOfCharts[0].destroy();
        listOfCharts = listOfCharts.slice(1);
        if (listOfCharts.length === 0) {
            return true;
        }
    }

    function createChart() {
        var promise = new Promise(function(resolve, reject) {
            if (destroyPreviousChart()) {
                resolve("Stuff worked!");
            } else {
                reject(Error("It broke"));
            }
        });

        promise.then(function(){
            let chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: chartLabels,
                    datasets: [
                        {
                            label: ["Conservative"],
                            data: calculateDataPointsByYear(conservative),
                            fill: true,
                            backgroundColor: ['#102A5E'],
                            borderColor: ['#102A5E'],
                            borderWidth: 1
                        },
                        {
                            label: ["Moderate"],
                            data: calculateDataPointsByYear(moderate),
                            fill: true,
                            backgroundColor: ['#3F5A9E'],
                            borderColor: ['#3F5A9E'],
                            borderWidth: 1
                        },
                        {
                            label: ["Aggressive"],
                            data: calculateDataPointsByYear(aggressive),
                            fill: true,
                            backgroundColor: ['#41ade1'],
                            borderColor: ['#41ade1'],
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    elements: {
                        line: {
                            tension: 0.6, // bezier curves 0-1
                            spanGaps: true
                        },
                        toolTips: {
                            callbacks: {
                                label: function (tooltipItem, data) {
                                    var label = data.datasets[tooltipItem.datasetIndex].label || '';

                                    if (label) {
                                        label += 'age: ';
                                    }
                                    label += Math.round(tooltipItem.yLabel * 100) / 100;
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        showLines: false,
                        yAxes: [{
                            ticks: {
                            // remove money values from left
                                callback: function (value) {
                                    return null;
                                }
                            }
                        }],
                        xAxes: [{
                            stacked: false,
                            ticks: {
                                // remove age values but keep the vertical lines
                                callback: function (value) {
                                    return '';
                                }
                            }
                        }]
                    },
                    legend: {
                        display: false, // rectangle labels on top of chart
                    },
                    animation: {
                        easing: 'easeInOutCubic'
                    }
                }
            });
            listOfCharts.push(chart);
        });
    }

    function updateTotalValues() {
        const finalConservativeData = calculateDataPointsByYear(conservative);
        const finalModerateData = calculateDataPointsByYear(moderate);
        const finalAggressiveData = calculateDataPointsByYear(aggressive);

        document.getElementById("conservativeTotal").innerText = finalConservativeData[finalConservativeData.length-1];
        document.getElementById("moderateTotal").innerText = finalModerateData[finalModerateData.length-1];
        document.getElementById("aggressiveTotal").innerText = finalAggressiveData[finalAggressiveData.length-1];

        // add selected class to 0 saved & 100/mo by default
        const startValue = document.getElementsByClassName("startValue");
        const conservativeAmt = document.getElementById("conservativeAmt");
        conservativeAmt.innerText = "$" + Math.floor(startValue[1].value * conservative) + " / mo";

        const moderateAmt =document.getElementById("moderateAmt");
        moderateAmt.innerText = "$" + Math.floor(startValue[1].value * moderate) + " / mo";

        const aggressiveAmt =document.getElementById("aggressiveAmt");
        aggressiveAmt.innerText = "$" + Math.floor(startValue[1].value * aggressive) + " / mo";
        //////////////////////////////
    }

    function updateChart(event, id) {
        // Grabs all the elements from inside the ul whom had its onclick triggered
        let nodes = document.getElementById(id).childNodes;
        // Filters through the inner elements and returns only the li elements
        let liArray = Array.from(nodes).filter((node)=>{
            return node.nodeName === 'LI';
        });

        // Used to prevent the ul itself from having an unwanted class added, only allows button elements
        if (event.target.nodeName === 'BUTTON') {
            // Loops through all the sibling buttons and removes the .selected-amount class from the non selected buttons
            liArray.forEach((li)=>{
                if (li.childNodes[0].nodeName === 'INPUT') {
                    li.childNodes[0].value = '';
                } else if (li.childNodes[0].value !== event.target.value) {
                    li.childNodes[0].classList.remove('selected-amount');
                }

            });

            if (id === "money-saved") {
                totalSaved = Number(event.target.value);
                event.target.classList.add('selected-amount');
                // updateChart(Number(event.target.value), monthlySavings);
                createChart();

            } else if (id === "money-income") {
                annualIncome = event.target.value;
                event.target.classList.add('selected-amount');

            } else if (id === "money-saved-monthly"){
                monthlySavings = Number(event.target.value);
                event.target.classList.add('selected-amount');
                createChart();
                // updateChart(totalSaved, Number(event.target.value));
            }
        }

        updateTotalValues();
    }

    // onchange get value
    function getAmount(value, id) {
        if ( id === "money-saved-input") {
            totalSaved = value;
            // updateChart(value, monthlySavings);
            createChart();
        } else if ( id === "annual-income") {
            annualIncome = value;
        } else if (id === "monthly-savings"){
            monthlySavings = value;
            // updateChart(totalSaved, value);
            createChart();
        }
    }

    calculateLabels(25,65);
    createChart();
    updateTotalValues();
    const startValue = document.getElementsByClassName("startValue");
    startValue[0].classList.add('selected-amount'); // 0 saved
    startValue[1].classList.add('selected-amount'); // 100 will save /mo
</script>